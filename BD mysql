DELIMITER $$
USE proyecto$$
CREATE PROCEDURE PA_INSERTAR_TRANSACCIONAL (PIDCUENTAORIGEN INT, PIDCUENTADESTINO INT,  PVALOR NUMERIC(10,2))
BEGIN
DECLARE saldo_actual_cuentaA NUMERIC(10,2);
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN
SELECT 'An error has occurred, operation rollbacked and the stored procedure was terminated';
ROLLBACK;
END;
START TRANSACTION;
IF EXISTS (SELECT * FROM cuenta WHERE IDCUENTA=PIDCUENTAORIGEN) AND
EXISTS (SELECT * FROM cuenta WHERE IDCUENTA=PIDCUENTADESTINO) THEN
SELECT saldo INTO saldo_actual_cuentaA FROM cuenta WHERE IDCUENTA = PIDCUENTAORIGEN FOR UPDATE;
IF saldo_actual_cuentaA >= PVALOR THEN
insert into TRANSFERENCIA values(PIDCUENTAORIGEN,PIDCUENTADESTINO,PVALOR);
insert into MOVIMIENTO(IDCUENTA,TIPOMOVIMIENTO,VALOR) values(PIDCUENTADESTINO,'A',PVALOR);
update CUENTA set SALDO=saldo+PVALOR where IDCUENTA=PIDCUENTADESTINO;
insert into MOVIMIENTO(IDCUENTA,TIPOMOVIMIENTO,VALOR) values(PIDCUENTAORIGEN,'D',PVALOR);
update CUENTA set SALDO=saldo-PVALOR where IDCUENTA=PIDCUENTAORIGEN;
SELECT 'La transferencia se realizo con exito' AS resultado;
ELSE
SELECT 'Saldo insuficiente para realizar la transferencia' AS resultado;
END IF;
ELSE
SELECT 'CUENTA INEXISTENTE';
END IF;
COMMIT;
END;
$$
DELIMITER $$

call PA_INSERTAR_TRANSACCIONAL (1, 2, 300);
